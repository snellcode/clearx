"use strict";(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):(a=a||self,b(a.ClearX={}))})(void 0,function(a){'use strict';let b=0,c=()=>(b+=1,`clearx-${b}`);var d="undefined"==typeof globalThis?"undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?{}:self:global:window:globalThis,e=function(a,b){return b={exports:{}},a(b,b.exports),b.exports}(function(a){(function(b,c){a.exports=c()})(d,function(){function a(a){return!!a&&"object"==typeof a}function b(a){var b=Object.prototype.toString.call(a);return"[object RegExp]"===b||"[object Date]"===b||c(a)}// see https://github.com/facebook/react/blob/b5ac963fb791d1298e7f396236383bc955f916c1/src/isomorphic/classic/element/ReactElement.js#L21-L25
function c(a){return a.$$typeof===n}function d(a){return Array.isArray(a)?[]:{}}function e(a,b){return!1!==b.clone&&b.isMergeableObject(a)?k(d(a),a,b):a}function f(a,b,c){return a.concat(b).map(function(a){return e(a,c)})}function g(a,b){if(!b.customMerge)return k;var c=b.customMerge(a);return"function"==typeof c?c:k}function h(a){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(a).filter(function(b){return a.propertyIsEnumerable(b)}):[]}function i(a){return Object.keys(a).concat(h(a))}function j(a,b,c){var d={};return c.isMergeableObject(a)&&i(a).forEach(function(b){d[b]=e(a[b],c)}),i(b).forEach(function(f){d[f]=c.isMergeableObject(b[f])&&a[f]?g(f,c)(a[f],b[f],c):e(b[f],c)}),d}function k(a,b,c){c=c||{},c.arrayMerge=c.arrayMerge||f,c.isMergeableObject=c.isMergeableObject||l;var d=Array.isArray(b),g=Array.isArray(a);return d===g?d?c.arrayMerge(a,b,c):j(a,b,c):e(b,c)}var l=function(c){return a(c)&&!b(c)},m="function"==typeof Symbol&&Symbol.for,n=m?Symbol.for("react.element"):60103;k.all=function(a,b){if(!Array.isArray(a))throw new Error("first argument should be an array");return a.reduce(function(a,c){return k(a,c,b)},{})};return k})}),f=Array.isArray,g=Object.keys,h=Object.prototype.hasOwnProperty,i=function c(d,a){if(d===a)return!0;if(d&&a&&"object"==typeof d&&"object"==typeof a){var b,e,j,k=f(d),l=f(a);if(k&&l){if(e=d.length,e!=a.length)return!1;for(b=e;0!=b--;)if(!c(d[b],a[b]))return!1;return!0}if(k!=l)return!1;var m=d instanceof Date,n=a instanceof Date;if(m!=n)return!1;if(m&&n)return d.getTime()==a.getTime();var o=d instanceof RegExp,p=a instanceof RegExp;if(o!=p)return!1;if(o&&p)return d.toString()==a.toString();var q=g(d);if(e=q.length,e!==g(a).length)return!1;for(b=e;0!=b--;)if(!h.call(a,q[b]))return!1;for(b=e;0!=b--;)if(j=q[b],!c(d[j],a[j]))return!1;return!0}return d!==d&&a!==a};const j=a=>isNaN(a)?a:1*a,k=(a,b,c)=>!m(a[b],c)&&(a[b]=c,a[b]===c),l=a=>(Object.freeze&&Object.freeze(a),a),m=(a,b)=>void 0!==a&&i(a,b),n=(a,b=".",c="\\")=>{if(!a)return[];if(Array.isArray(a))return a;const d=[];let e="";for(let f=0,g=a.length;f<g;++f){const g=a[f];g===b&&a[f-1]!==c?(0<e.length&&d.push(j(e)),e=""):g!==c&&(e+=a[f])}return 0<e.length&&d.push(j(e)),d},o=(a,b,c)=>{if(void 0===a)return c;if(!b||0===b.length)return a;b=n(b);let[d,...e]=b;return isNaN(d)||(d*=1),o(a[d],e,c)},p=(a,b,c,d)=>{let e=!1;if(a===void 0)return[!1,e];if(!b||0===b.length)return[!1,e];b=n(b);const[f,g,...h]=b;if(void 0!==g){if(!a.hasOwnProperty(f)){const b=isNaN(g)?{}:[];e=k(a,f,b)}const[b,i]=p(a[f],[g,...h],c,d);return[b,i||e]}return a.hasOwnProperty(f)&&d?[!0,e]:(e=k(a,f,c),[!0,e])},q=(a,b)=>{const c=o(a,b);return void 0!==c},r=(a,b,c=null)=>p(a,b,c,!0),s=["push","pop","splice","shift","unshift","sort","slice"],t=(a,b,c,...d)=>{if(-1===s.indexOf(c))return!1;let e=o(a,b);Array.isArray(e)||(e=[],p(a,b,e));let f;try{f=e[c].apply(e,d)}catch(a){// Probably freeze!
}return[!0,!0,f]},u=(a,b,...c)=>t(a,b,"push",...c),v=(a,b,c,d)=>void 0===d?u(a,b,c):t(a,b,"splice",d,0,c),w=(a,b,...c)=>t(a,b,"unshift",...c),x=(a,b)=>t(a,b,"pop"),y=(a,b)=>t(a,b,"shift"),z=(a,b,...c)=>t(a,b,"splice",...c),A=(a,b,...c)=>{const d=t(a,b,"slice",...c);return d[2]},B=(a,b,...c)=>t(a,b,"sort",...c),C=(a,b,c=1)=>{let d=1*o(a,b);return isNaN(d)&&(d=0),d+=c,p(a,b,d)},D=(a,b,c=1)=>C(a,b,-1*c),E=(a,b)=>{const c=!!o(a,b);return p(a,b,!c)},F=(a,b)=>{let c=!1;const d=o(a,b);if(d===void 0)return[!0,c];let e;switch(!0){case"string"==typeof d:e="";break;case"number"==typeof d:e=0;break;case"boolean"==typeof d:e=!1;break;case Array.isArray(d):return d.length=0,[!0,0===d.length];case"object"==typeof d:for(const a in d)d.hasOwnProperty(a)&&(c=delete d[a]||c);return[!0,c];}return p(a,b,e)},G=(a,b,c)=>{for(let d=0,e=b.length;d<e;++d){const c=o(a,b[d]);if(c!==void 0&&null!==c)return c}return c},H=(a,b)=>{let c=!1;if(a===void 0)return[!1,c];if(!b||0===b.length)return[!1,c];b=n(b);const[d,...e]=b;if(1===b.length){if(Array.isArray(a)&&!isNaN(d)){const b=a.length;a.splice(d,1),c=b!==a.length}else a.hasOwnProperty(d)&&(c=delete a[d]);return[!0,c]}return H(a[d],[...e])},I=(a,b,c)=>{r(a,b,Array.isArray(c)?[]:{});const d=o(a,b),f=e(d,c);return p(a,b,f)},J=(a,b,c)=>{const d=o(a,b);return i(d,c)};class K{constructor(a,b=".",c,d){this.paths=a,this.delimiter=b,this.store=c,this.dataObserver=d,this.components=[],this._afterUpdateEvents=[],this._dataTransformers=[]}get keys(){const a=this.paths;if(Array.isArray(a))return a;let b=[];if("string"==typeof a)b=[n(a,this.delimiter)];else if("[object Object]"===a.toString())for(const c in a)a.hasOwnProperty(c)&&b.push(n(a[c],this.delimiter));else return a;return b}observe(a){if(0===this.components.length&&!a)return;if(this.cancelObserver)return;const b=this.dataObserver,c=this.keys,d=this.updateComponents.bind(this);this.cancelDataListener=b.attachObserver(c,d)}unobserve(){this.cancelDataListener&&(this.cancelDataListener(),delete this.cancelDataListener)}listenUnmount(a,b){if(Array.isArray(a))return()=>{};const c=a.componentWillUnmount;a.componentWillUnmount=()=>{b(),"function"==typeof this.componentWillUnmount&&this.componentWillUnmount.call(a)},a.componentWillUnmount.__original=c}unlistenUnmount(a){const b=a.componentWillUnmount;if(b){const b=a.componentWillUnmount.__original;b&&(a.componentWillUnmount=b)}}dataTransformer(a){return"function"==typeof a?(this._dataTransformers.push(a),this.updateComponents(),()=>{const b=this._dataTransformers.indexOf(a);-1<b&&this._dataTransformers.splice(b,1)}):()=>{}}get dataTransformers(){return this._dataTransformers.slice(0)}applyDataTransformers(a){return this._dataTransformers.forEach(b=>{try{a=b(a)}catch(c){console.log(b,"failing to transform",a)}}),a}updateData(){let a={},b=this.paths;if("string"==typeof b)b=n(b,this.delimiter),a=this.store.get(b);else if(Array.isArray(b))a=b.map(a=>{const b=n(a,this.delimiter);return this.store.get(b)});else for(const c in b){const d=n(b[c],this.delimiter);a[c]=this.store.get(d)}a=this.applyDataTransformers(a),"object"==typeof a&&(a=l(e({},a))),this._data=a}get data(){return this._data||this.updateData(),this._data}updateComponents(){this.updateData(),this.components.forEach(a=>{this.assignState(a)}),this.executeAfterUpdate()}assignStateFC(a,b){let c;if(Array.isArray(a)&&(c=a[1]),!!c)return!!b||(a[0]=this._data,c(this._data),!0)}assignStateCC(a,b){if("function"==typeof a.setState)return b?(a.state=a.state||{},a.state.store=a.state.store||{},a.state.store={...a.state.store,...this.data}):a.setState({...a.state,store:{...a.state.store,...this.data}}),!0}assignStateOthers(a){"object"==typeof a&&(a.data=this.data)}assignState(a,b=!1){const c=this.assignStateFC(a,b),d=this.assignStateCC(a,b);c||d||this.assignStateOthers(a,b)}onUpdate(a){return"function"==typeof a?(this._afterUpdateEvents.push(a),()=>{const b=this._afterUpdateEvents.indexOf(a);-1<b&&this._afterUpdateEvents.splice(b,1)}):()=>{}}get afterUpdateEvents(){return this._afterUpdateEvents.slice(0)}executeAfterUpdate(){this._afterUpdateEvents.forEach(a=>{try{a(this.data)}catch(a){console.log(a)}})}get hasDataListener(){return!!this.cancelDataListener}addMark(a,b){let c=a;Array.isArray(a)&&(c=a[1]),c.__segment=b}removeMark(a){let b=a;Array.isArray(a)&&(b=a[1]),delete b.__segment}}class L{constructor(a,b,d,e,f){this.id=b||c(),this.paths=a,this._helper=new K(a,d,e,f),this.delimiter=d,this.store=e,this.dataObserver=f}findComponent(a){if(!this._helper)return-1;Array.isArray(a)&&(a=a[1]);const b=this._helper.components;for(let c,d=0;d<b.length;d++)if(c=b[d],Array.isArray(c)&&(c=c[1]),a===c)return d;return-1}get data(){return this._helper?this._helper.data:{}}get components(){return this._helper?this._helper.components.slice(0):[]}get active(){return!!this._helper&&this._helper.hasDataListener}get afterUpdateEvents(){return this._helper?this._helper.afterUpdateEvents:[]}get dataTransformers(){return this._helper?this._helper.dataTransformers:[]}link(a){if(!a)return{};const b=this._helper;if(!b)return{};const c=this.store,d=c._unlinkComponentFromAllSegments.bind(c,a),e=[this.data,d];return-1<this.findComponent(a)?e:(b.components.push(a),b.observe(this.keepSyncing),b.addMark(a,this),b.listenUnmount(a,d),b.assignState(a,!0),e)}unlink(a){if(!a)return!1;const b=this._helper;if(!b)return!1;const c=this.findComponent(a);return-1<c&&(b.removeMark(a),b.components.splice(c,1),b.unlistenUnmount(a)),0!==b.components.length||this.keepSyncing||b.unobserve(),-1<c}sync(a=!0){return!!this._helper&&(this.keepSyncing=a,a&&!this.active&&this._helper.observe(!0),!a&&this.active&&this._helper.unobserve(),!0)}unlinkAll(){return!!this._helper&&(this._helper.components.forEach(this.unlink.bind(this)),!0)}onUpdate(a){return this._helper?this._helper.onUpdate(a):()=>{}}dataTransformer(a){return this._helper?this._helper.dataTransformer(a):()=>{}}teardown(){return!this._helper||(this.unlinkAll(),this._helper.unobserve(),delete this._helper,delete this.dataObserver,this.store.removeSegment(this),!0)}}class M{constructor(a){this.store=a,this.listeners={},this.counter=0}attachObserver(a,b){if(!b)return;if(!a||0===a.length)return;++this.counter;const c=`data-slice:${this.counter}`;return this.listeners[c]={keys:a,listener:b},()=>{delete this.listeners[c]}}dataUpdatedAt(a){const b=[],c=n(a).join(">>");for(const d in this.listeners){let{keys:a,listener:e}=this.listeners[d];a=a.filter(a=>{const b=n(a).join(">>");return b.startsWith(c)||c.startsWith(b)}),0<a.length&&b.push([a,e])}b.forEach(([a,b])=>{try{b(a)}catch(c){console.log("Error updating",b,a)}})}teardown(){this.listeners={}}}a.ClearX=class{constructor(a){this.data=a,this.segments=[],this.dataObserver=new M(this),this.delimiter=".",this.onUpdateEvents=[]}triggerEvents(a){this.dataObserver.dataUpdatedAt(a)}executeUtil(a,[b,c,d]){return c&&this.triggerEvents(a),this.executeOnUpdateEvents(c,a),b}get(a,b){return o(this.data,a,b)}set(a,b,c=!1){return this.executeUtil(a,p(this.data,a,b,c))}coalesce(a,b){return G(this.data,a,b)}empty(a){return this.executeUtil(a,F(this.data,a))}insert(a,b,c){return this.executeUtil(a,v(this.data,a,b,c))}push(a,...b){return this.executeUtil(a,u(this.data,a,...b))}unshift(a,...b){return this.executeUtil(a,w(this.data,a,...b))}pop(a){return this.executeUtil(a,x(this.data,a))}shift(a){return this.executeUtil(a,y(this.data,a))}splice(a,...b){return this.executeUtil(a,z(this.data,a,...b))}slice(a,...b){return A(this.data,a,...b)}sort(a,...b){return this.executeUtil(a,B(this.data,a,...b))}ensureExists(a,b){return this.executeUtil(a,r(this.data,a,b))}delete(a){return this.executeUtil(a,H(this.data,a))}has(a){return q(this.data,a)}merge(a,b){return this.executeUtil(a,I(this.data,a,b))}increment(a,b){return this.executeUtil(a,C(this.data,a,b))}decrement(a,b){return this.executeUtil(a,D(this.data,a,b))}toggle(a){return this.executeUtil(a,E(this.data,a))}isEqual(a,b){return J(this.data,a,b)}paths(a,b){const c=new L(a,b,this.delimiter,this,this.dataObserver);return this.segments.push(c),c}bind(a={}){const{to:b,afterUpdate:c,id:d,paths:e,dataTransformer:f}=a;let g=b;Array.isArray(g)&&(g=b[1]);let h;if(h=g.__segment,h)return h.link(b);h=this.paths(e,d,this.delimiter),h.onUpdate(c),h.dataTransformer(f);const i=h.link(b);return Array.isArray(b)?i:h}removeSegment(a){const b=this.segments.indexOf(a);return!!(-1<b)&&(a.teardown(),this.segments.splice(b,1),!0)}onUpdate(a){return"function"==typeof a?(this.onUpdateEvents.push(a),()=>{const b=this.onUpdateEvents.indexOf(a);-1<b&&this.onUpdateEvents.splice(b,1)}):()=>{}}executeOnUpdateEvents(a,b){this.onUpdateEvents.forEach(c=>{try{c(a,b,this.data,this)}catch(a){console.log("onUpdate",c,b)}})}_unlinkComponentFromAllSegments(a){this.segments.forEach(b=>{b.unlink(a)})}teardown(){return this.segments.forEach(a=>{a.teardown()}),this.dataObserver.teardown(),delete this.dataObserver,this.data={},!0}},Object.defineProperty(a,"__esModule",{value:!0})});
//# sourceMappingURL=clearx.umd.js.map
